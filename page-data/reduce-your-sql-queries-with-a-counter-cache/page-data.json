{"componentChunkName":"component---src-templates-blog-post-js","path":"/reduce-your-sql-queries-with-a-counter-cache/","webpackCompilationHash":"","result":{"data":{"site":{"siteMetadata":{"title":"Charlie Massry","author":"Charlie Massry"}},"markdownRemark":{"id":"b018a0a0-82f2-5262-8370-837aaf8015ef","excerpt":"Counter caching is a technique to reduce the number or SQL queries when attempting to call count on a resources’ association. For example, on my blog, I have…","html":"<p>Counter caching is a technique to reduce the number or SQL queries when attempting to call count on a resources’ association. For example, on my blog, I have posts which have many comments, and on the index page, I am displaying the number of comments on each post. Originally it was firing off ten SQL queries for this plus one for all the posts, but I was able to reduce it to just one because I implemented a counter cache.</p>\n<p>This past weekend I taught at <a href=\"https://www.bridgetroll.org/\">Railsbridge</a> and towards the end the students seemed very enthusiastic about implementing this counter cache in order to add sorting functionality and performance. The app was called Suggestotron which was a simple app that lets a user add a topic such as <code class=\"language-text\">&quot;fruit&quot;</code> and then the user can vote on it and any other topics. While this app was simple, we were able to finish early and begin the extra suggested exercises. One was to sort the topics by the votes count. One idea that was tossed around was to implement a counter cache on the association. To add a counter cache to the Topic model we would need to generate a migration.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ rails generate migration AddVotesCountToTopic votes_count:integer</code></pre></div>\n<p>This generates a migration with the appropriate timestamp.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">class AddVotesCountToTopic &lt; ActiveRecord::Migration\n  def change\n    add_column :topics, :votes_count, :integer\n  end\nend</code></pre></div>\n<p>This will add the right column, but if we think about it, this is not exactly what we want. Two problems come to mind. First, the column will default to <code class=\"language-text\">nil</code> which is bad as we can’t perform an operation like <code class=\"language-text\">nil + 1</code>. If we do, we will get something like <code class=\"language-text\">NoMethodError: undefined method &#39;+&#39; for nil:NilClass</code>. Ideally we’d like to start a zero. Also we would like to update the column for records that already have votes on them. To do this we will have to execute Ruby code to take the result of <code class=\"language-text\">topic.votes.count</code> and set it to <code class=\"language-text\">topic.votes_count</code>. We can do this with an iterator like <code class=\"language-text\">#each</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">class AddVotesCountToTopic &lt; ActiveRecord::Migration\n  def change\n    add_column :topics, :votes_count, :integer, default: 0\n\n    topics = Topic.all\n\n    topics.each do |topic|\n    topic.update!(votes_count: topic.votes.count)\n    end\n  end\nend</code></pre></div>\n<p>The code <code class=\"language-text\">default: 0</code> will automatically set the <code class=\"language-text\">votes_count</code> column to <code class=\"language-text\">0</code> instead of <code class=\"language-text\">nil</code>, and the iterator will make sure <code class=\"language-text\">votes_count</code> accurately reflects the number of votes. Also we want to use <code class=\"language-text\">#update!</code> instead of <code class=\"language-text\">#update</code> because it will raise an error if it fails and undo the migration instead of a half finished migration.</p>\n<p>Now you can run that migration.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ rake db:migrate</code></pre></div>\n<p>Now that you have your database set up, how will Rails know to increment the counter every time? You could add it into your controller on vote creation, or you can use this <a href=\"http://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to\">belongs_to</a> option, <code class=\"language-text\">counter_cache: true</code>. In the model that is on the <code class=\"language-text\">belongs_to</code> end of the relationship, in this case Votes, we can add the counter cache association.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">class Vote &lt; ActiveRecord::Base\n  belongs_to :topic, counter_cache: true\nend</code></pre></div>\n<p>Now every time the Topic receives a vote it increments the <code class=\"language-text\">votes_count</code> column. Also if you were to use the destroy method, it would decrement the <code class=\"language-text\">votes_count</code> column. Now we are ready to sort by votes.</p>\n<p>Adding the code for this is now easier and more efficient. In the controller to display topics by the number of votes, we can change the index method to finalize this feature.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">class TopicsController &lt; ApplicationController\n  def index\n    @topics = Topic.order(votes_count: :desc)\n  end\nend</code></pre></div>\n<p>Now that your topics have their votes counted and ordered, you can display them in the view using embedded Ruby.</p>","frontmatter":{"title":"Reduce Your SQL Queries With a Counter Cache","date":"November 17, 2014"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/reduce-your-sql-queries-with-a-counter-cache/","previous":{"fields":{"slug":"/metaprogramming-with-method-missing/"},"frontmatter":{"title":"Metaprogramming with Method Missing","id":46}},"next":{"fields":{"slug":"/how-to-debug-rails-apps/"},"frontmatter":{"title":"How to Debug Rails Apps","id":48}}}}}